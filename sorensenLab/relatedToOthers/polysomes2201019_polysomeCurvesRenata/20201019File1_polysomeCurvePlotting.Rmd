---
title: "Polysome curve plotting"
output:
  html_notebook:
      code_folding: none
---

This document details plotting of curves from polysome fractionation. 

## Setting up the environment

These are packages you will need for this notebook. For exact versions used, please refer to the session info at the bottom of this notebook.

```{r, message = FALSE, warning = FALSE}
###########################################################
library('tidyverse')
library('ggplot2')
library('RColorBrewer')
library('zoo')
```

<div style="margin-bottom:50px;"></div>

Set the base folders where we will do the work.

```{r}
###########################################################
baseWorkspace = 'C:/Users/chughes/Documents/bccrc/projectsWorkspace/sorensenLab/relatedToOthers'
baseRepository = 'C:/Users/chughes/Documents/bccrc/projectsRepository/sorensenLab/relatedToOthers'
#baseWorkspace = 'C:/Users/chris/OneDrive/Documents/bccrc/projectsWorkspace/sorensenLab/relatedToYbx1'
#baseRepository = 'C:/Users/chris/OneDrive/Documents/bccrc/projectsRepository/sorensenLab/relatedToYbx1'
```

<div style="margin-bottom:50px;"></div>

## Data processing

Read the curve file generated by the fractionator.

```{r, message = FALSE, warning = FALSE}
###########################################################
polyData = read_csv(paste(baseRepository, '/polysomes2201019_polysomeCurvesRenata/rs_20201016_chla10ms275_dmso1.csv', sep = ''), skip = 45)
```

<div style="margin-bottom:50px;"></div>

Make a plot of the raw data.

```{r}
###########################################################
ggplot(polyData, aes(`Position(mm)`, Absorbance)) +
  geom_line(size = 0.25) + 
  scale_y_continuous(limits = c(0,6), breaks = seq(0,6,1))
```

<div style="margin-bottom:50px;"></div>

The first thing we want to do is subset the plot to get rid of the large peak at the start of the gradient. It makes it hard to see the actual polysome data. Based on the above plot, if we just cap the y-axis at a value of 1 and cut off the first 5-mm worth of data, it should be good.

```{r}
###########################################################
polyDataSubset = polyData %>%
  filter(`Position(mm)` >= 5 & Absorbance <= 1)
##
ggplot(polyDataSubset, aes(`Position(mm)`, Absorbance)) +
  geom_line(size = 0.25) + 
  scale_y_continuous(limits = c(0,1), breaks = seq(0,1,0.2))
```

<div style="margin-bottom:50px;"></div>

This looks better, but is a bit spikey in the early parts of the gradient. If we do some averaging of the data it might help.

```{r}
###########################################################
polyDataRoll = polyDataSubset %>%
  mutate(avgAbsorbance = rollmean(Absorbance, 4, fill = NA)) ##if you want to change the way the curve looks, change the numerical value here to be higher or lower
##
ggplot(polyDataRoll, aes(`Position(mm)`, avgAbsorbance)) +
  geom_line(size = 1, color = brewer.pal(8, 'Spectral')[8]) +
  labs(x = 'Position (mm)', y = 'Absorbance', title = 'Sucrose gradient - DMSO replicate 1') +
  scale_y_continuous(limits = c(0,1), breaks = seq(0,1,0.2)) +
  theme_classic()
ggsave(paste(baseRepository, '/line_polysomeGradientCurveSmooth.pdf', sep = ''),
       height = 4, width = 4, useDingbats = FALSE)
```

<div style="margin-bottom:50px;"></div>

What if we want to put multiple curves on a single plot? The most efficient way to do this is by make a long-format data table with groups.

We can either read files in one at a time and combine them into a single object:

```{r}
###########################################################
polyFile1 = read_csv(paste(baseRepository, '/polysomes2201019_polysomeCurvesRenata/rs_20201016_chla10ms275_dmso1.csv', sep = ''), skip = 45) %>%
  filter(`Position(mm)` >= 5 & Absorbance <= 1) %>%
  mutate(avgAbsorbance = rollmean(Absorbance, 3, fill = NA)) %>%
  mutate(sample = 'dmso1')
##
polyFile2 = read_csv(paste(baseRepository, '/polysomes2201019_polysomeCurvesRenata/rs_20201016_chla10ms275_dmso1.csv', sep = ''), skip = 45) %>%
  filter(`Position(mm)` >= 5 & Absorbance <= 1) %>%
  mutate(avgAbsorbance = rollmean(Absorbance, 3, fill = NA)) %>%
  mutate(`Position(mm)` = `Position(mm)` + 1) %>% #I just do this so the data will be shifted so it looks different...don't do for your real file
  mutate(sample = 'dmso2')
##
polyData = rbind(polyFile1, polyFile2)
polyData$sample = factor(polyData$sample, levels = c('dmso1','dmso2')) #this just determines the order that things are presented on the x-axis in a plot
```

<div style="margin-bottom:50px;"></div>

And we can make a plot exactly as we did before using this group to separate the two.

```{r}
###########################################################
ggplot(polyData, aes(`Position(mm)`, avgAbsorbance, color = sample)) +
  geom_line(size = 1) +
  labs(x = 'Position (mm)', y = 'Absorbance', title = 'Sucrose gradient') +
  scale_y_continuous(limits = c(0,1), breaks = seq(0,1,0.2)) +
  scale_color_manual(values = brewer.pal(8,'RdBu')[c(1,8)]) +
  theme_classic()
ggsave(paste(baseRepository, '/line_polysomeGradientCurveSmoothMultiple.pdf', sep = ''),
       height = 4, width = 4, useDingbats = FALSE)
```

<div style="margin-bottom:50px;"></div>

We could also use facet wrap to put them on separate plots.

```{r}
###########################################################
ggplot(polyData, aes(`Position(mm)`, avgAbsorbance)) +
  geom_line(size = 1, color = brewer.pal(8, 'Spectral')[8]) +
  labs(x = 'Position (mm)', y = 'Absorbance', title = 'Sucrose gradient') +
  scale_y_continuous(limits = c(0,1), breaks = seq(0,1,0.2)) +
  facet_wrap(~sample) +
  theme_classic()
ggsave(paste(baseRepository, '/line_polysomeGradientCurveSmoothMultiple.pdf', sep = ''),
       height = 4, width = 4, useDingbats = FALSE)
```

<div style="margin-bottom:50px;"></div>

If we don't want to do this manually for a bunch of files, we can read all the files in a directory and plot them all. First we read the list of files we want to process, each having a .csv extension.

```{r}
###########################################################
polyFiles = list.files(paste(baseRepository, '/polysomes2201019_polysomeCurvesRenata/', sep = ''), pattern = '.csv', full.names = TRUE)
```

<div style="margin-bottom:50px;"></div>

Now we create a function to do the same processing as above for each file in the list and to output them to the same data table.

```{r, warning = FALSE}
###########################################################
##create a function to process the files
polysomeProcessing = function(fileList, ...){
  polyData = read_csv(fileList, skip = 45) %>%
    filter(`Position(mm)` >= 5 & Absorbance <= 1) %>%
    mutate(avgAbsorbance = rollmean(Absorbance, 3, fill = NA)) %>%
    mutate(sample = sub('.*chla10ms275_(.*)\\.csv', '\\1', fileList))
  return(polyData)
}
##process the files
polyData = do.call(rbind, lapply(polyFiles, polysomeProcessing))

```

<div style="margin-bottom:50px;"></div>

Now we have our data all as one big object.

```{r}
###########################################################
polyData
##
table(polyData$sample)
```

<div style="margin-bottom:50px;"></div>

We can make the same plots as before using this bigger data set.

```{r}
###########################################################
ggplot(polyData, aes(`Position(mm)`, avgAbsorbance)) +
  geom_line(size = 1, color = brewer.pal(8, 'Spectral')[8]) +
  labs(x = 'Position (mm)', y = 'Absorbance', title = 'Sucrose gradient') +
  scale_y_continuous(limits = c(0,1), breaks = seq(0,1,0.2)) +
  facet_wrap(~sample, ncol = 3) +
  theme_classic()
ggsave(paste(baseRepository, '/line_polysomeGradientCurveSmoothAllSamples.pdf', sep = ''),
       height = 4, width = 4, useDingbats = FALSE)
```


## Session Info

```{r}
###########################################################
sessionInfo()
```








