---
title: "EwS encyclopedia data"
output:
  html_notebook:
      code_folding: none
---

This document details the analysis of microarray data from the EwS encyclopedia from GSE176190.

## Setting up the environment

These are packages you will need for this notebook. For exact versions used, please refer to the session info at the bottom of this notebook.

```{r, message=FALSE, warning=FALSE}
##########################################################################################
library('tidyverse')
library('ggplot2')
library('RColorBrewer')
#library('clariomdhumantranscriptcluster.db')
library('oligo')
library('ff')
library('affycoretools')
```

<div style="margin-bottom:50px;"></div>

I want to set a base directory that we can use as a link to the directory where we will do most of the work. I use two directories here because the Workspace is what is pushed to GitHub and contains scripts and plot files, but the Repository is where more of the big data is stored that does not get pushed.

```{r}
##########################################################################################
generalDatasets = 'C:/Users/chughes/Documents/bccrc/projectsRepository/generalDatasets'
baseWorkspace = 'C:/Users/chughes/Documents/bccrc/projectsWorkspace/sorensenLab/relatedToDlg2'
baseRepository = 'C:/Users/chughes/Documents/bccrc/projectsRepository/sorensenLab/relatedToDlg2'
#generalDatasets = 'C:/Users/chris/OneDrive/Documents/bccrc/projectsRepository/generalDatasets'
#baseWorkspace = 'C:/Users/chris/OneDrive/Documents/bccrc/projectsWorkspace/sorensenLab/relatedToYbx1'
#baseRepository = 'C:/Users/chris/OneDrive/Documents/bccrc/projectsRepository/sorensenLab/relatedToYbx1'
```

<div style="margin-bottom:50px;"></div>

## Data processing

The first thing I need to do is set the annotation. I use a CDF from BrainArray (in this case, version 25). 

```{r}
##########################################################################################
#these are the install commands for my windows machine
#install.packages('C:/Users/chughes/Documents/bccrc/databases/microarrays/clariomDHuman/pd.clariomdhuman.hs.refseq_25.0.0.tar.gz', repos = NULL, type = 'source')
#install.packages('C:/Users/chughes/Documents/bccrc/databases/microarrays/clariomDHuman/clariomdhumanhsrefseq.db_25.0.0.tar.gz', repos = NULL, type = 'source')
#these were for when I had to run it on linux because of memory issues
#install.packages('/home/chughes/databases/microarray/clariomDHuman/pd.clariomdhuman.hs.refseq_25.0.0.tar.gz', repos = NULL, type = 'source')
#install.packages('/home/chughes/databases/microarray/clariomDHuman/clariomdhumanhsrefseq.db_25.0.0.tar.gz', repos = NULL, type = 'source')

#load the packages
library('pd.clariomdhuman.hs.refseq')
library('clariomdhumanhsrefseq.db')
```

<div style="margin-bottom:50px;"></div>

Now read in the data files and process them with rma from the oligo package. 

```{r}
##########################################################################################
#following directions here: https://support.bioconductor.org/p/72378/#72552
allData = tibble()
for (i in seq(1,108,27)){
  dat = read.celfiles(list.celfiles(paste(baseRepository, '/microarray20211026_grunewaldEwsEncyclopedia', sep = ''), full.names=TRUE)[i:i+26], pkgname = 'pd.clariomdhuman.hs.refseq')
  rmaEset = rma(dat)
  annotatedEset = annotateEset(eset, clariomdhumanhsrefseq.db)
  expressionData = as_tibble(exprs(annotatedEset)) %>%
    dplyr::mutate(PROBEID = rownames(annotatedEset)) %>%
    dplyr::rename_with(~ sub('(.*)_[0-9]+\\-[0-9]+\\.CEL', '\\1', .x))
  annotationData = as_tibble(fData(annotatedEset)) %>%
    left_join(expressionData)
  #
  allData = allData %>%
    left_join(annotationData)
}






saveRDS(exprs(eset), paste(baseRepository, '/microarray20211026_grunewaldEwsEncyclopedia/dataset_allSamplesOligoRmaRefseqCdf.rds', sep = ''))
```

<div style="margin-bottom:50px;"></div>

Below is some linux code. 

dat = read.celfiles(list.celfiles('/mnt/Data/chughes/projectsRepository/sorensenLab/relatedToDlg2/microarray20211026_grunewaldEwsEncyclopedia', full.names=TRUE)[1:6], pkgname = 'pd.clariomdhuman.hs.refseq')
saveRDS(exprs(eset), '/mnt/Data/chughes/projectsRepository/sorensenLab/relatedToDlg2/microarray20211026_grunewaldEwsEncyclopedia/dataset_allSamplesOligoRmaRefseqCdf.rds')









#######################################
this is old processing code and was not used in the end
######################################

```{r}
##########################################################################################
#I downloaded custom CDF files from http://brainarray.mbni.med.umich.edu/Brainarray/Database/CustomCDF/CDF_download.asp
library('clariomdhumanhsrefseqcdf')
#celSubset = affy::ReadAffy(filenames = celFiles[1], cdfname = 'clariomdhumanhsrefseqcdf')

#take a look at the probe format just to see what the ID is like
topProbes = head(ls(clariomdhumanhsrefseqcdf))
topProbes

#ENSG00000150672 is DLG2
#NM_001377978.1 is DLG2 short
#NM_001300983.1 is DLG2 long
dim(get('NM_001300983.1_at', clariomdhumanhsrefseqcdf))
dim(get('NM_001377978.1_at', clariomdhumanhsrefseqcdf))

#read in a subset of the cel files and look at DLG2 expression
#celFiles = affy::list.celfiles(path = paste(baseRepository, '/microarray20211026_grunewaldEwsEncyclopedia/', sep = ''), full.names = TRUE)
celData = affy::ReadAffy(celfile.path = paste(baseRepository, '/microarray20211026_grunewaldEwsEncyclopedia/', sep = ''),
                  cdfname = 'clariomdhumanhsrefseqcdf')
rmaExprs = exprs(affy::rma(celData))
head(rmaExprs)
saveRDS(rmaExprs, paste(baseRepository, '/microarray20211026_grunewaldEwsEncyclopedia/dataset_allSamplesAffyRmaRefseqCdf.rds', sep = ''))

##########################################################################################
#####I had to run this code on the linux server because it kept failing here with the whole dataset
library('tidyverse')
library('affy')
library('clariomdhumanhsrefseqcdf')
celData = affy::ReadAffy(celfile.path = '/mnt/Data/chughes/projectsRepository/sorensenLab/relatedToDlg2/microarray20211026_grunewaldEwsEncyclopedia/', cdfname = 'clariomdhumanhsrefseqcdf')
rmaExprs = exprs(affy::rma(celData))
saveRDS(rmaExprs, '/mnt/Data/chughes/projectsRepository/sorensenLab/relatedToDlg2/microarray20211026_grunewaldEwsEncyclopedia/dataset_allSamplesAffyRmaRefseqCdf.rds')
##actually, this also failed on the linux server...segmentation fault. Maybe it is something with the affy package? We can try with oligo, but we will need to build our own cdf package.
```




